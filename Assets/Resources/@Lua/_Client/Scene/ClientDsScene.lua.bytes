local DsScene = _MOE.class("ClientDsScene", _MOE.BaseScene)

DsScene[".superctor"] = true -- 会调用父类方法

function DsScene:Ctor(sceneName, dsNetworkManager, isSinglePlay)
    self.DsNetworkManager = dsNetworkManager
    self.Transport = dsNetworkManager.gameObject:GetComponent(typeof(CS.Unity.Netcode.Transports.UTP.UnityTransport))
    self.SceneLoader = dsNetworkManager.gameObject:GetComponent(typeof(_MOE.BaseResLoaderAsyncType))
    if isSinglePlay == nil then
        isSinglePlay = false
    end
    self.IsSinglePlay = isSinglePlay
end

local function GenerateScenesInBuild(self)
    local SceneManager = self.DsNetworkManager.SceneManager
    if SceneManager then
        local dsData = _MOE.TB["dsData"]
        local scenes = {dsData.scene}
        _MOE.NetCodeHelper.InitHelper(SceneManager)
        _MOE.NetCodeHelper.GenerateScenesInBuild2(SceneManager, scenes)
    end
end

local function RegisterDSClientEvents(self)
    _MOE.DsNetworkHelper.NetworkManager_SetOnClientStopped(
                        function (b)
                            self:_OnClient_ClientStopped(b)
                        end
                    )
        _MOE.DsNetworkHelper.NetworkManager_SetOnClientStarted(
            function ()
                self:_OnClient_ClientStarted()
            end
        )
end

local function UnRegisterDSClientEvents()
    if _MOE.DsNetworkHelper and _MOE.DsNetworkHelper.NetworkManager_ClearAllEvents then
        _MOE.DsNetworkHelper.NetworkManager_ClearAllEvents()
    end
end

local function LoadMainSceneABAsync(self, sceneName)
    if not self.SceneLoader or not sceneName or string.len(sceneName) <= 0 then
        return false
    end
    local ret = self.SceneLoader:LoadMainSceneABAsync(sceneName)
    --[[
    if ret then
        self.CurrentMainSceneName = sceneName
    end
    ]]
    return ret
end

function DsScene:_OnClient_ClientStopped(b)
    _MOE.Logger.Log("[DsScene] OnConnectionEvent: " .. tostring(b))
    UnRegisterDSClientEvents()
end

function DsScene:_OnClient_ClientStarted()
    UnRegisterDSClientEvents()
end

--- 设置DS验证信息
function DsScene:SetConnectionApprovalData()
end

function DsScene:_InitDSClientNet()
    self:SetConnectionApprovalData() -- 设置DS验证信息
    local dsData = _MOE.TB["dsData"]
    self.Transport:SetConnectionData(dsData.ip, dsData.port)
    if self.DsNetworkManager:StartClient() then
        GenerateScenesInBuild(self)
        RegisterDSClientEvents(self)
        local SceneManager = self.DsNetworkManager.SceneManager
        self:RegsterCSharpEvent(SceneManager, "OnClientPreCheckLoadSceneAndCallNext",
                        self._OnClient_PreCheckLoadSceneAndCallNext)
    end
end

function DsScene:_OnClient_MultiPlay_OnMainSceneABLoad(sceneName, loadTag)
    if not sceneName or loadTag ~= "onlyAB" then
        return
    end

    if self.OnClientSceneLoadCallBack then
        self.OnClientSceneLoadCallBack()
        self.OnClientSceneLoadCallBack = nil
    end
end

function DsScene:_OnClient_PreCheckLoadSceneAndCallNext(sceneName, onNextCallBack)
    if not self.SceneLoader then
        return true
    end
    self.OnClientSceneLoadCallBack = onNextCallBack
    self:RegsterCSharpEvent(self.SceneLoader, "onSceneLoaded", self._OnClient_MultiPlay_OnMainSceneABLoad)
    if not LoadMainSceneABAsync(self, sceneName) then
        _MOE.Logger.LogErrorFormat(
        "[DsScene] _OnClient_PreCheckLoadSceneAndCallNext Error: not vaild sceneName({0})", sceneName)
        return true -- 让他报错
    end
    return false
end

-- Host模式
function DsScene:_InitDSHostNet()
end

function DsScene:_UnInitDSNet()
    UnRegisterDSClientEvents()
    _MOE.NetCodeHelper.UnInitHelper()
    self.OnClientSceneLoadCallBack = nil
end

function DsScene:OnEnter()
    _MOE.Logger.Log("DsScene Enter")
    if self.IsSinglePlay then
        self:_InitDSHostNet() -- 单机模式
    else
        self:_InitDSClientNet() -- 联机模式
    end
end

function DsScene:OnExit()
    _MOE.EventManager:UnRegisterEvents(self)
    self:_UnInitDSNet()
    self.DsNetworkManager = nil
    self.Transport = nil
    self.SceneLoader = nil
end

return DsScene