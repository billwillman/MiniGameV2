local Locomotion = _MOE.class("DemoCharacter_Locomotion", _MOE.SkillBase)

function Locomotion:GetActionNames()
    local ret = {
        "Loom_walk_run"
    }
    return ret
end

-- xlua.private_accessible(CS.Animancer.AnimancerEvent)

function Locomotion:OnInit()
    Locomotion:CallSuper("OnInit", self)

    self.ActionMap = {
        ["Loom_walk_run"] = {
            OnInit = function (animState)
                if not animState then
                    return
                end
                animState:SetFloat("SpeedY", 0.5)
                --self:AnimationState_BindAllEvents(animState)
            end
        }
    }
    self.CurrentMoveSpeed = 0
    self.Camera = _MOE.FindMainCamera()
end

function Locomotion:OnScriptObjectLoaded(resName, translition)
    _MOE.Logger.LogFormat("[Locomotion] resName: {0}", resName)
    if translition and self.ActionMap[resName] then
        self.ActionMap[resName].animState = translition
        local animState = self:PlayAction(translition)
        self.ActionMap[resName].OnInit(animState)
        self.CurrentAnimState = animState
    end
end

function Locomotion:GetCurrentMoveSpeed()
    return self.CurrentMoveSpeed or 0
end

function Locomotion:UpdateSpeedToAnimState()
    if self.CurrentAnimState then
        local SpeedY = 0.5 + self:GetCurrentMoveSpeed()/2.0
        self.CurrentAnimState:SetFloat("SpeedY", SpeedY)
    end
end

-- 重置IDLE
function Locomotion:ResetIdle()
    self:UnRegisterCharacterKCC()

    self.CurrentMoveSpeed = 0
    self:UpdateSpeedToAnimState()
    self:UnRegisterLuaEventUpdate()
    self.MovePt = nil
end

-- 根据相机更新角色朝向（暂时这样直接硬切，后续用子状态机来切换状态，限定一个范围，超过范围，则做一个快速转动后再移动，再范围内再硬切）
function Locomotion:UpdateForwardByControlCamera()
    if self.Camera then
        local forward = self.Camera.transform.forward
        forward.y = 0
        local transform = self:GetOwnerTransform()
        local originforward = _MOE.Vector3(0, 0, 1)
        -- 旋转
        local angle = _MOE.Vector3.Angle(originforward, forward)
        angle = forward.x < 0 and -angle or angle
        transform.eulerAngles = _MOE.Vector3(0, angle, 0)
    end
end

function Locomotion:OnKcc_UpdateRotation()
end

function Locomotion:RegisterCharacterKCC()
    local luaPlayerController = _MOE.LocalLuaCharacterController
    if luaPlayerController then
        local kccController = luaPlayerController:GetKCC_CharacterController()
        if kccController then
            self:RegsterCSharpEvent(kccController, "onUpdateRotation", self.OnKcc_UpdateRotation)
        end
    end
end

function Locomotion:UnRegisterCharacterKCC()
    local luaPlayerController = _MOE.LocalLuaCharacterController
    if luaPlayerController then
        local kccController = luaPlayerController:GetKCC_CharacterController()
        if kccController then
            self:UnRegsterCSharpEvent(kccController, "onUpdateRotation")
        end
    end
end

function Locomotion:BeginMoveControl()
    if not self:IsRegisterLuaEventUpdate() then
        self:RegisterLuaEventUpdate()
        xpcall(self.RegisterCharacterKCC, _G.ErrorHandler, self)
   end
end

function Locomotion:EndMoveControl()
    self:ResetIdle() -- 重置IDLE
end

function Locomotion:OnSkillBaseInputEvent(actionName, Context)
    if actionName == "Move" then
        -- 移动
        if Context.actionType == _MOE.InputActionPhase.Performed or Context.actionType == _MOE.InputActionPhase.Canceled then
            if self.CurrentAnimState  then
                local movePt = Context:GetVector2D()
                -- _MOE.Logger.LogFormat("[movePt]: ({0:F}, {1:F})", movePt.x, movePt.y)
                if movePt.y > 0 then
                    self.MovePt = movePt
                    self:BeginMoveControl()
                else
                    self:EndMoveControl()
                end
            end
        end
    end
end

function Locomotion:ResetData()
    self.CurrentAnimState = nil
    self.MovePt = nil
    self.Camera = nil
end

function Locomotion:OnExit()
    xpcall(self.UnRegisterCharacterKCC, _G.ErrorHandler, self)
    self:ResetData()
    Locomotion:CallSuper("OnExit", self)
end

function Locomotion:OnDispose()
    xpcall(self.UnRegisterCharacterKCC, _G.ErrorHandler, self)
    self:ResetData()
    Locomotion:CallSuper("OnDispose", self)
end

function Locomotion:UpdateCurrentMoveSpeed()
    if self.MovePt ~= nil then
        if self.MovePt.y > 0 then
            self.CurrentMoveSpeed = self.CurrentMoveSpeed + 2 * _MOE.UnityTime.deltaTime
            self.CurrentMoveSpeed = math.min(1.0, self.CurrentMoveSpeed)
            -- _MOE.Logger.LogFormat("[Locomotion] Speed: {0:F}", self.CurrentMoveSpeed)
            self:UpdateSpeedToAnimState()
        end
    end
end

function Locomotion:OnUpdate()
    Locomotion:CallSuper("OnUpdate", self)
    self:UpdateForwardByControlCamera()
    self:UpdateCurrentMoveSpeed()
end

return Locomotion