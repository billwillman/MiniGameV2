local CSharpEventContainer = require("_Common.CSharpEventContainer")

local BaseCharacterController = _MOE.class("BaseCharacterController", CSharpEventContainer)

function BaseCharacterController:Ctor(CharacterController, binder)
    self.CharacterController = CharacterController
    self.Binder = binder

    local EventType = _MOE.LuaEvent_MonoEventType
    self.Binder:RegisterLuaEvent(EventType.Destroyed:GetHashCode(), self.OnDestroy)

    if not _MOE.IsDS then
        -- Client操作
        _MOE.LocalLuaCharacterController = self -- 局部Character Controller
    end

    self:RegisterNetworkEvents()
end

function BaseCharacterController:RegisterNetworkEvents()
    if self.CharacterController then
        local PawnObj = self.CharacterController.PawnObj
        if PawnObj then
            self:RegsterCSharpEvent(PawnObj, "onNetworkSpawn", self.OnNetworkSpawn)
            self:RegsterCSharpEvent(PawnObj, "onNetworkDespawn", self.OnNetworkDespawn)
        end
    end
end

function BaseCharacterController:OnNetworkSpawn()
    if not _MOE.IsDS then
        if self:IsLocalOwner() then
            local kccController = self:GetKCCharacterController()
            if kccController then
                kccController.enabled = true
            end
            --- 事件通知CharacterController
            _MOE.EventManager:DispatchEvent("On_Local_Character_ReceiveBegin")
        else
            _MOE.EventManager:DispatchEvent("On_Simlate_Character_ReceiveBegin")
        end
    elseif _MOE.IsDS then
        _MOE.EventManager:DispatchEvent("On_Server_Character_ReceiveBegin")
    end
end

function BaseCharacterController:OnNetworkDespawn()
    if not _MOE.IsDS then
        if self:IsLocalOwner() then
            --- 事件通知CharacterController
            _MOE.EventManager:DispatchEvent("On_Local_Character_ReceiveEnd")
        else
            _MOE.EventManager:DispatchEvent("On_Simlate_Character_ReceiveEnd")
        end
    else
        _MOE.EventManager:DispatchEvent("On_Server_Character_ReceiveEnd")
    end
end

function BaseCharacterController:IsLocalOwner()
    if not self.CharacterController then
        return false
    end
    return self.CharacterController.IsLocalOwner
end

function BaseCharacterController:GetOwnerCharacter()
    local controller = self:GetMoeCharacterController()
    if controller then
        local ret = controller.gameObject
        return ret
    end
end

function BaseCharacterController:GetOwnerCharacterTransform()
    local controller = self:GetMoeCharacterController()
    if controller then
        local ret = controller.transform
        return ret
    end
end

function BaseCharacterController:GetMoeCharacterController()
    return self.CharacterController
end

function BaseCharacterController:GetKCCharacterController()
    local moeCharacterController = self:GetMoeCharacterController()
    if moeCharacterController then
        return moeCharacterController.Motor
    end
end

function BaseCharacterController:OnDestroy()
    _MOE.EventManager:UnRegisterEvents(self)
    self:UnRegsterAllCsharpEvents()

    self.CharacterController = nil
    self.Binder = nil
    if not _MOE.IsDS then
        _MOE.LocalLuaCharacterController = nil
    end
end

return BaseCharacterController